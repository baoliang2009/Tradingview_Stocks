# 回测系统使用指南

## 概述

`backtest.py` 是一个完整的回测系统，用于评估 QQE 趋势策略在不同质量阈值下的表现。

## 主要功能

1. ✅ **多质量阈值对比**：同时测试多个质量阈值的表现
2. ✅ **完整交易模拟**：包含手续费、滑点等真实交易成本
3. ✅ **详细性能指标**：胜率、盈亏比、夏普比率、最大回撤等
4. ✅ **结果导出**：自动保存CSV格式的汇总和详细交易记录
5. ✅ **可视化对比**：不同质量阈值的性能对比表格

## 快速开始

### 基本用法

```bash
# 默认配置：回测100只创业板+科创板股票
python3 backtest.py

# 回测所有创业板股票
python3 backtest.py --board chinext --max-stocks 200

# 回测科创板
python3 backtest.py --board star --max-stocks 100

# 使用标准模式
python3 backtest.py --no-strict
```

### 自定义质量阈值

```bash
# 测试不同的质量阈值
python3 backtest.py --quality-thresholds 50,60,70,75,80

# 只测试单个质量阈值
python3 backtest.py --quality-thresholds 70

# 测试更细粒度的阈值
python3 backtest.py --quality-thresholds 55,60,65,70,75,80,85
```

## 参数说明

| 参数 | 类型 | 默认值 | 说明 |
|------|------|--------|------|
| `--board` | string | chinext+star | 板块筛选 |
| `--max-stocks` | int | 100 | 最大股票数量 |
| `--quality-thresholds` | string | 0,50,60,70,80 | 质量阈值列表（逗号分隔） |
| `--no-strict` | flag | False | 使用标准模式 |
| `--history-days` | int | 250 | 历史数据天数 |
| `--delay` | float | 0.1 | 请求间隔(秒) |

## 回测配置

### 交易成本设置

回测引擎默认配置（可在代码中修改）：

```python
BacktestEngine(
    initial_capital=100000,    # 初始资金：10万
    commission=0.0003,         # 手续费率：0.03%（双向）
    slippage=0.001,            # 滑点：0.1%
    position_size=1.0          # 仓位比例：100%
)
```

### 交易规则

1. **买入信号**：使用开盘价买入（模拟集合竞价）
2. **卖出信号**：使用开盘价卖出
3. **持仓管理**：满仓操作（可调整 position_size）
4. **成本计算**：
   - 买入成本 = 买入价 × (1 + 滑点 + 手续费)
   - 卖出所得 = 卖出价 × (1 - 滑点 - 手续费)

## 回测指标说明

### 基础指标

| 指标 | 说明 |
|------|------|
| 总交易次数 | 产生的买入信号总数 |
| 已平仓交易 | 已经卖出的交易数 |
| 胜率 | 盈利交易占比 |
| 平均收益 | 所有交易的平均收益率 |
| 中位数收益 | 收益率的中位数（更能反映典型情况） |
| 最大收益 | 单笔交易最大收益率 |
| 最大亏损 | 单笔交易最大亏损率 |

### 高级指标

| 指标 | 说明 | 理想值 |
|------|------|--------|
| 平均盈利 | 盈利交易的平均收益率 | 越高越好 |
| 平均亏损 | 亏损交易的平均亏损率 | 越低越好 |
| 盈亏比 | 平均盈利 / 平均亏损 | > 1.5 |
| 平均持有天数 | 平均持仓时间 | 根据策略而定 |
| 累计收益 | 复利累计收益率 | 越高越好 |
| 最大回撤 | 从峰值到谷底的最大跌幅 | 越小越好，<20% |
| 夏普比率 | 风险调整后收益 | > 1.0 |

## 输出结果

### 1. 屏幕输出

#### 单个质量阈值结果示例

```
================================================================================
回测结果 - 质量阈值: 70分
================================================================================
总交易次数: 45
已平仓交易: 38
胜率: 68.89%
平均收益: 3.25%
中位数收益: 2.80%
最大收益: 18.50%
最大亏损: -8.20%
平均盈利: 6.50%
平均亏损: 3.80%
盈亏比: 1.71
平均持有天数: 12.5
累计收益: 156.30%
最大回撤: -15.60%
夏普比率: 1.35
平均信号质量: 75.3分
```

#### 对比分析表格

```
质量阈值    交易次数    胜率%       平均收益%    累计收益%    最大回撤%    盈亏比      夏普比率   
----------------------------------------------------------------------------------------------------
0         120        58.33      1.85        98.50       -22.30      1.25       0.85      
50        95         62.11      2.45        135.20      -18.50      1.42       1.05      
60        68         65.22      2.95        148.60      -16.20      1.58       1.22      
70        45         68.89      3.25        156.30      -15.60      1.71       1.35      
80        25         72.00      3.85        168.50      -12.80      1.92       1.58      
```

### 2. CSV 文件输出

#### 汇总文件

文件名格式：`backtest_summary_{board}_{mode}_{timestamp}.csv`

示例：`backtest_summary_chinext+star_strict_20260201_150030.csv`

包含所有质量阈值的性能指标汇总。

#### 交易详情文件

文件名格式：`backtest_trades_{board}_{mode}_q{quality}_{timestamp}.csv`

示例：`backtest_trades_chinext+star_strict_q70_20260201_150030.csv`

包含每笔交易的详细信息：
- 股票代码和名称
- 买入日期、价格、成本
- 卖出日期、价格、净收入
- 收益率、持有天数
- 信号质量、交易状态

## 使用场景

### 场景1：寻找最佳质量阈值

```bash
# 测试多个质量阈值，找出最优配置
python3 backtest.py --max-stocks 200 \
  --quality-thresholds 50,55,60,65,70,75,80,85
```

**分析重点**：
- 哪个质量阈值的胜率最高？
- 哪个质量阈值的累计收益最高？
- 哪个质量阈值的风险调整后收益（夏普比率）最好？
- 交易次数与收益的平衡点在哪里？

### 场景2：验证策略有效性

```bash
# 大样本回测，验证策略是否真实有效
python3 backtest.py --board chinext+star --max-stocks 500 \
  --quality-thresholds 60,70,80 --history-days 300
```

**分析重点**：
- 胜率是否 > 50%？
- 盈亏比是否 > 1？
- 是否存在正期望收益？
- 最大回撤是否可接受？

### 场景3：对比不同模式

```bash
# 严格模式回测
python3 backtest.py --max-stocks 200 --quality-thresholds 60,70,80

# 标准模式回测
python3 backtest.py --max-stocks 200 --quality-thresholds 60,70,80 --no-strict
```

**分析重点**：
- 严格模式和标准模式哪个表现更好？
- 信号数量和质量的权衡
- 不同模式适合的市场环境

### 场景4：板块策略研究

```bash
# 创业板回测
python3 backtest.py --board chinext --max-stocks 300

# 科创板回测
python3 backtest.py --board star --max-stocks 200

# 全市场回测
python3 backtest.py --board all --max-stocks 1000 --delay 0.2
```

**分析重点**：
- 策略在不同板块的表现差异
- 哪个板块更适合这个策略？
- 板块轮动的可能性

## 结果解读

### 好的回测结果特征

✅ **胜率 > 60%**
- 说明策略有较好的预测能力

✅ **盈亏比 > 1.5**
- 盈利交易的收益显著大于亏损交易

✅ **夏普比率 > 1.0**
- 风险调整后的收益良好

✅ **最大回撤 < 20%**
- 风险控制在可接受范围内

✅ **累计收益 > 50%**（假设测试期1年）
- 策略有实际盈利能力

### 质量阈值选择建议

根据回测结果选择质量阈值：

**保守型**：
- 选择胜率最高、回撤最小的阈值
- 通常在 75-80 分
- 交易次数少但质量高

**平衡型**：
- 选择夏普比率最优的阈值
- 通常在 65-75 分
- 平衡收益和风险

**积极型**：
- 选择累计收益最高的阈值
- 通常在 60-70 分
- 更多交易机会

## 注意事项

### 1. 过拟合风险

⚠️ **不要过度优化参数**
- 避免针对历史数据过度调整
- 保留一定的样本外测试
- 定期重新回测验证

### 2. 幸存者偏差

⚠️ **退市股票影响**
- baostock 数据可能不包含已退市股票
- 实际收益可能略低于回测结果

### 3. 市场环境变化

⚠️ **策略的时效性**
- 牛市和熊市表现可能差异很大
- 需要在不同市场环境下测试
- 定期更新回测验证策略有效性

### 4. 滑点和手续费

⚠️ **真实交易成本**
- 回测设置的滑点可能偏小
- 实际交易可能面临更大滑点
- 预留一定的安全边际

## 高级用法

### 修改交易成本

编辑 `backtest.py`，修改 `BacktestEngine` 初始化参数：

```python
engine = BacktestEngine(
    initial_capital=100000,    # 初始资金
    commission=0.0005,         # 提高手续费率到 0.05%
    slippage=0.002,            # 提高滑点到 0.2%
    position_size=0.5          # 半仓操作
)
```

### 自定义回测期

```bash
# 测试更长的历史数据
python3 backtest.py --history-days 500

# 测试较短期数据（快速验证）
python3 backtest.py --history-days 150
```

### 并行回测（脚本化）

创建 `run_backtest.sh`：

```bash
#!/bin/bash

# 回测创业板
python3 backtest.py --board chinext --max-stocks 300 &

# 回测科创板
python3 backtest.py --board star --max-stocks 200 &

# 等待完成
wait

echo "所有回测完成"
```

## 实战建议

### 回测流程

1. **快速验证**（50-100只股票）
   ```bash
   python3 backtest.py --max-stocks 100 --quality-thresholds 60,70,80
   ```

2. **深度测试**（200-500只股票）
   ```bash
   python3 backtest.py --max-stocks 300 --quality-thresholds 55,60,65,70,75,80
   ```

3. **全面回测**（1000+只股票）
   ```bash
   python3 backtest.py --board all --max-stocks 1000 --delay 0.2
   ```

### 结果验证

1. ✅ 检查交易次数是否足够（至少30笔以上）
2. ✅ 分析胜率和盈亏比是否达标
3. ✅ 观察最大回撤是否可接受
4. ✅ 对比不同质量阈值的表现
5. ✅ 选择综合表现最优的配置

### 实盘应用

根据回测结果：
- 选择最优质量阈值
- 设置合理的止损止盈
- 控制仓位大小
- 严格执行纪律

## 常见问题

**Q: 回测100只股票需要多久？**

A: 取决于历史数据天数和延迟设置：
- 100只 × 0.1秒 ≈ 10秒（获取数据）
- 每只股票计算 ≈ 1秒
- 总计约 2-3 分钟

**Q: 可以回测全市场吗？**

A: 可以，但需要更长时间：
```bash
python3 backtest.py --board all --max-stocks 5000 --delay 0.3
```
预计耗时：约 30-60 分钟

**Q: 如何解读对比结果？**

A: 重点关注：
1. 胜率变化趋势
2. 夏普比率（综合指标）
3. 交易次数与收益的平衡
4. 选择综合评分最高的阈值

**Q: 为什么我的回测结果和实盘不同？**

A: 可能的原因：
- 滑点设置偏小
- 手续费设置偏低
- 未考虑停牌、涨跌停等限制
- 市场环境变化

## 总结

回测系统帮助你：
1. ✅ 验证策略有效性
2. ✅ 找到最优质量阈值
3. ✅ 评估风险收益特征
4. ✅ 建立交易信心
5. ✅ 优化参数配置

**开始使用**：
```bash
python3 backtest.py --max-stocks 200 --quality-thresholds 60,70,80
```

祝你回测顺利！📈
