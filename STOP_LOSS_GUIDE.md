# 止损功能说明

## 概述

回测系统已经实现**自动止损功能**，可以在股票亏损达到设定阈值时自动平仓，有效控制风险。

## 功能特性

### 1. 止损触发机制

- **检测频率**: 每日检查（使用当天最低价）
- **触发条件**: 当日最低价导致的亏损率 ≤ -止损比例
- **默认止损比例**: 10% （即亏损达到-10%时触发）
- **优先级**: 止损检查优先于卖出信号检查

### 2. 止损计算方法

```python
# 买入成本（包含手续费和滑点）
买入成本 = 买入价格 × (1 + 滑点 + 手续费)
         = 买入价格 × (1 + 0.001 + 0.0003)
         = 买入价格 × 1.0013

# 当前收益率（使用当天最低价）
当前收益率 = (当天最低价 - 买入成本) / 买入成本

# 止损触发
if 当前收益率 <= -止损比例:
    触发止损，以当天最低价卖出
```

### 3. 退出原因标记

系统会记录每笔交易的退出原因：

| 退出原因 | 说明 | 
|---------|------|
| `stop_loss` | 触发止损退出 |
| `signal` | 策略卖出信号退出 |
| `open` | 持有至回测结束（未平仓）|

## 使用方法

### 命令行参数

```bash
# 使用默认10%止损
python3 backtest.py --board chinext+star --max-stocks 100 --quality-thresholds 70

# 自定义止损比例为5%
python3 backtest.py --stop-loss 0.05 --quality-thresholds 70

# 自定义止损比例为15%
python3 backtest.py --stop-loss 0.15 --quality-thresholds 70

# 禁用止损（设置为100%）
python3 backtest.py --stop-loss 1.0 --quality-thresholds 70
```

### 参数说明

- `--stop-loss`: 止损比例（浮点数）
  - 默认值: `0.10` （10%）
  - 范围: 0.01 - 1.0
  - 示例: `0.05` = -5%, `0.10` = -10%, `0.20` = -20%

## 回测结果解读

### 1. 单个质量阈值的结果

```
==================================================================================
回测结果 - 质量阈值: 70分
==================================================================================
总交易次数: 150
已平仓交易: 142
胜率: 56.52%
平均收益: 2.34%
...
最大回撤: -15.23%   ← 止损后最大回撤显著降低
夏普比率: 0.45

退出方式统计:
  止损退出: 45次 (30.0%)      ← 有30%的交易通过止损退出
  信号退出: 85次 (56.7%)      ← 有56.7%的交易通过信号退出
  持有中: 20次                 ← 有13.3%的交易仍在持有
```

### 2. 对比分析表格

```
质量阈值    交易次数    胜率%     平均收益%   累计收益%   最大回撤%   止损率%   盈亏比    夏普比率
----------------------------------------------------------------------------------------
60        180       54.21    1.89      156.23    -18.45    35.00    1.85    0.38
70        150       56.52    2.34      189.67    -15.23    30.00    2.01    0.45
80        98        59.18    3.12      198.45    -12.67    25.00    2.34    0.52
```

**止损率**: 表示通过止损退出的交易占总交易的百分比
- 止损率越高，说明更多交易在亏损时被及时止损
- 止损率适中（20-40%）通常表示策略质量较好

### 3. CSV导出文件

#### 交易详情文件

文件名格式: `backtest_trades_chinext+star_strict_q70_20260201_123456.csv`

包含字段：
- `stock_code`: 股票代码
- `stock_name`: 股票名称
- `buy_date`: 买入日期
- `buy_price`: 买入价格
- `sell_date`: 卖出日期
- `sell_price`: 卖出价格
- `profit_pct`: 收益率
- `holding_days`: 持有天数
- `signal_quality`: 信号质量分数
- **`exit_reason`**: 退出原因（stop_loss/signal/open）← 新增
- **`status`**: 交易状态（closed/open）

## 止损效果分析

### 预期改善效果

启用10%止损后，通常会看到：

| 指标 | 无止损 | 10%止损 | 改善 |
|-----|--------|---------|------|
| 最大回撤 | -47.73% | -20%左右 | ✓ 显著降低 |
| 平均亏损 | -15.23% | -10%左右 | ✓ 控制在止损阈值附近 |
| 胜率 | 58% | 55%左右 | ⚠ 可能略微下降 |
| 夏普比率 | 0.20 | 0.40+ | ✓ 风险调整后收益提升 |

### 止损率合理范围

- **20-30%**: 优秀策略，大部分交易能按信号退出
- **30-40%**: 良好策略，适度止损保护
- **40-50%**: 一般策略，较多交易需要止损
- **>50%**: 策略质量较差，需要优化信号质量

## 最佳实践建议

### 1. 不同市场环境的止损设置

```bash
# 震荡市场 - 使用较宽止损
python3 backtest.py --stop-loss 0.15 --quality-thresholds 70

# 趋势市场 - 使用标准止损
python3 backtest.py --stop-loss 0.10 --quality-thresholds 70

# 高波动市场 - 使用严格止损
python3 backtest.py --stop-loss 0.08 --quality-thresholds 70
```

### 2. 配合质量阈值使用

高质量信号可以使用相对宽松的止损：

```bash
# 高质量信号（80分）+ 标准止损（10%）
python3 backtest.py --quality-thresholds 80 --stop-loss 0.10

# 中等质量信号（70分）+ 严格止损（8%）
python3 backtest.py --quality-thresholds 70 --stop-loss 0.08

# 对比测试不同组合
python3 backtest.py --quality-thresholds 70,80 --stop-loss 0.10
```

### 3. 分析止损原因

定期查看CSV文件中 `exit_reason='stop_loss'` 的记录：

```python
import pandas as pd

# 读取交易详情
df = pd.read_csv('backtest_trades_chinext+star_strict_q70_20260201_123456.csv')

# 分析止损交易
stop_loss_trades = df[df['exit_reason'] == 'stop_loss']

print(f"止损交易数: {len(stop_loss_trades)}")
print(f"平均持有天数: {stop_loss_trades['holding_days'].mean():.1f}")
print(f"平均亏损: {stop_loss_trades['profit_pct'].mean():.2f}%")

# 查看哪些股票经常触发止损
frequent_stop_loss = stop_loss_trades['stock_name'].value_counts().head(10)
print("\n经常止损的股票:")
print(frequent_stop_loss)
```

## 技术实现细节

### 止损检查流程

```python
for date, row in future_data.iterrows():
    # 1. 使用最低价检查止损
    current_price = row['low']
    current_return = (current_price - buy_cost) / buy_cost
    
    # 2. 优先检查止损
    if current_return <= -self.stop_loss:
        sell_date = date
        sell_price = current_price
        exit_reason = 'stop_loss'
        break
    
    # 3. 如果未触发止损，检查卖出信号
    if date in sell_signals.index:
        sell_date = date
        sell_price = row['open']
        exit_reason = 'signal'
        break
```

### 关键设计要点

1. **使用最低价**: 确保止损能够及时触发，不会错过当天的最大跌幅
2. **包含交易成本**: 买入成本包含手续费和滑点，真实反映盈亏
3. **优先级设计**: 止损优先于卖出信号，确保风险控制优先
4. **记录详细信息**: 保存退出原因，便于后续分析优化

## 测试验证

系统提供了单元测试脚本验证止损逻辑：

```bash
# 运行止损逻辑测试
python3 test_stop_loss_logic.py
```

预期输出示例：
```
止损逻辑单元测试
场景1: 买入100元，然后价格下跌到85元
止损触发日: 第5天
止损价格: 90.00
最终收益率: -10.23%
✓ 止损逻辑正常工作！
```

## 常见问题

### Q1: 为什么实际亏损超过10%？

A: 由于包含交易成本（手续费0.03% + 滑点0.1%），实际止损后的亏损通常在-10.2%左右，这是正常的。

### Q2: 止损后胜率下降了，是否有问题？

A: 这是正常现象。止损会锁定部分亏损交易，导致亏损交易数量增加，但重要的是**最大回撤降低**和**夏普比率提升**。

### Q3: 如何选择合适的止损比例？

A: 建议通过回测对比不同止损比例的效果：
```bash
# 同时测试5%, 8%, 10%, 15%止损
for sl in 0.05 0.08 0.10 0.15; do
    python3 backtest.py --stop-loss $sl --quality-thresholds 70 --max-stocks 50
done
```

### Q4: 止损率太高（>50%）怎么办？

A: 说明信号质量不够好，建议：
1. 提高质量阈值（如从70分提高到80分）
2. 使用严格模式
3. 缩短历史数据天数，聚焦近期市场

## 版本历史

- **v2.3**: 首次引入止损功能
  - 支持自定义止损比例
  - 记录退出原因
  - 增加止损统计指标
  - 更新CSV导出格式
